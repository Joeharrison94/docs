<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A collection of my findings throught both my enterprise and home labbing experiences"><link href=https://sudo-kraken.github.io/gcp-free-forever/ rel=canonical><link rel=prev href=..><link href=../cloudflared/ rel=next><link rel=icon href=../assets/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.4"><title>Google Cloud Platform - Free Forever VM Setup & Configuration - JH Docs</title><link rel=stylesheet href=../assets/stylesheets/main.50c56a3b.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../stylesheets/extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=orange> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#google-cloud-platform-deploys-an-ubuntu-minimal-os-virtual-machine-with-docker-ce-and-docker-compose-installed-using-terraform class=md-skip> Skip to content </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <style>
    div[data-md-component="announce"] {
        z-index: 10;
    }

    div[data-md-component="announce"] a {
        color: white;
    }

    div[data-md-component="announce"] a:hover, div[data-md-component="announce"] a:focus {
        transition: ease-in 150ms;
        color: #ccc;
    }

    div[data-md-component="announce"] .md-banner__button {
        color: #ccc;
    }

    div[data-md-component="announce"] .md-banner.hidden {
        display: none;
    }

    div[data-md-component="announce"] .twemoji {
        margin-top: 2px;
    }
</style> <button id=announce-bar-close class="md-banner__button md-icon" aria-label="Don't show this again"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"> <path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path> </svg> </button> If you like my repos, please consider supporting me via <a target=_blank href=https://www.buymeacoffee.com/jharrison94 style="vertical-align: middle;"><img src=https://www.buymeacoffee.com/assets/img/custom_images/orange_img.png alt="Buy Me A Coffee" style="height: auto !important; width: auto !important; vertical-align: middle;"></a> <script>
    announceBarKey = 'announce-bar-closed-sponsor';
    document.getElementById('announce-bar-close').addEventListener('click', (e) => {
        localStorage.setItem(announceBarKey, 'true');
        document.querySelector('div[data-md-component="announce"] .md-banner').style.display = 'none';
    });
    if (localStorage.getItem(announceBarKey) === 'true') {
        document.querySelector('div[data-md-component="announce"] .md-banner').style.display = 'none';
    }
</script> </div> </aside> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=/docs/ title="JH Docs" class="md-header__button md-logo" aria-label="JH Docs" data-md-component=logo> <img src=../assets/portal.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> JH Docs </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Google Cloud Platform - Free Forever VM Setup & Configuration </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=orange aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=teal data-md-color-accent=orange aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/sudo-kraken/terraform-gcp-ubuntu-container-ready-e2-micro-vm title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> sudo-kraken </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=/docs/ title="JH Docs" class="md-nav__button md-logo" aria-label="JH Docs" data-md-component=logo> <img src=../assets/portal.png alt=logo> </a> JH Docs </label> <div class=md-nav__source> <a href=https://github.com/sudo-kraken/terraform-gcp-ubuntu-container-ready-e2-micro-vm title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> sudo-kraken </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> Welcome </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Tutorials </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Google Cloud Platform - Free Forever VM Setup & Configuration </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Google Cloud Platform - Free Forever VM Setup & Configuration </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#google-cloud-platform-account-registration class=md-nav__link> <span class=md-ellipsis> Google Cloud Platform Account Registration </span> </a> </li> <li class=md-nav__item> <a href=#google-shell-api-vps-deployment-prep class=md-nav__link> <span class=md-ellipsis> Google Shell API &amp; VPS Deployment Prep </span> </a> </li> <li class=md-nav__item> <a href=#api-user-setup class=md-nav__link> <span class=md-ellipsis> API User Setup </span> </a> </li> <li class=md-nav__item> <a href=#vps-vm-deployment class=md-nav__link> <span class=md-ellipsis> VPS / VM Deployment </span> </a> </li> <li class=md-nav__item> <a href=#docker-containers-uptime-kuma-healthschecks class=md-nav__link> <span class=md-ellipsis> Docker Containers - Uptime Kuma &amp; Healthschecks! </span> </a> </li> <li class=md-nav__item> <a href=#setting-the-public-firewall class=md-nav__link> <span class=md-ellipsis> Setting The Public Firewall </span> </a> </li> <li class=md-nav__item> <a href=#setting-up-a-cloudflared-argo-tunnel-with-zero-trust class=md-nav__link> <span class=md-ellipsis> Setting Up A Cloudflared Argo Tunnel With Zero Trust! </span> </a> </li> <li class=md-nav__item> <a href=#links class=md-nav__link> <span class=md-ellipsis> Links </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../cloudflared/ class=md-nav__link> <span class=md-ellipsis> Cloudflared Argo Tunnels with Zero Trust </span> </a> </li> <li class=md-nav__item> <a href=../kvm-ubuntu/ class=md-nav__link> <span class=md-ellipsis> Install KVM (Kernel-Based Virtualization) On Ubuntu Server </span> </a> </li> <li class=md-nav__item> <a href=../mkdocs-cheatsheet/ class=md-nav__link> <span class=md-ellipsis> Markdown Cheatsheet For MkDocs </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=google-cloud-platform-deploys-an-ubuntu-minimal-os-virtual-machine-with-docker-ce-and-docker-compose-installed-using-terraform><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M23 14.75C23 18.2 20.2 21 16.75 21h-9.5C3.8 21 1 18.2 1 14.75c0-2.14 1.08-4.03 2.71-5.15C4.58 5.82 7.96 3 12 3c4.04 0 7.42 2.82 8.29 6.6A6.22 6.22 0 0 1 23 14.75M16.63 17c1.31 0 2.37-1.06 2.37-2.37 0-1.28-1-2.33-2.28-2.38l.03-.5a4.754 4.754 0 0 0-8.32-3.14c1.5.29 2.8 1.11 3.71 2.25L9.5 13.5c-.42-.73-1.21-1.25-2.12-1.25-1.32 0-2.38 1.06-2.38 2.38 0 1.27 1 2.3 2.25 2.37h9.38Z"/></svg></span> Google Cloud Platform - Deploys an Ubuntu Minimal OS Virtual Machine with Docker-ce and Docker Compose installed using Terraform<span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 5.4v6.4L15.4 15V8.7L21 5.4m-6.2 3.3V15l-5.6-3.2V5.4l5.6 3.3m0 7v6.4l-5.6-3.2v-6.4l5.6 3.2M8.6 5.1v6.4L3 8.3V1.9l5.6 3.2Z"/></svg></span><a class=headerlink href=#google-cloud-platform-deploys-an-ubuntu-minimal-os-virtual-machine-with-docker-ce-and-docker-compose-installed-using-terraform title="Permanent link">&para;</a></h1> <div class="admonition tip"> <p class=admonition-title>My Github Repo For This Project</p> <p><a href=https://github.com/Joeharrison94/terraform-gcp-ubuntu-container-ready-e2-micro-vm>My Github Link - Joeharrison94 / terraform-gcp-ubuntu-container-ready-e2-micro-vm</a></p> </div> <p>Using the below instructions and supplied files in the repo, you will be able to deploy an e2-micro instance into GCP via <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 5.4v6.4L15.4 15V8.7L21 5.4m-6.2 3.3V15l-5.6-3.2V5.4l5.6 3.3m0 7v6.4l-5.6-3.2v-6.4l5.6 3.2M8.6 5.1v6.4L3 8.3V1.9l5.6 3.2Z"/></svg></span> Terraform. This is the free forever tier so it shouldn't cost you a thing.</p> <p>This version comes with <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg></span> docker &amp; docker compose pre-installed. It will also inject a compose file into the app data drive in <code>/mnt/disks/docker/projects/app</code> my example contains an Uptime Kuma and Healthchecks container.</p> <p>Before you continue make sure that you have your <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 18h-2V9.25L12 13 6 9.25V18H4V6h1.2l6.8 4.25L18.8 6H20m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Z"/></svg></span> Gmail account credentials handy as you will need them to setup the Google Cloud account.</p> <hr> <h2 id=google-cloud-platform-account-registration>Google Cloud Platform Account Registration<a class=headerlink href=#google-cloud-platform-account-registration title="Permanent link">&para;</a></h2> <p>Firstly you should understand what exactly you are sigining up for, we are making this account to gain access to the GCP (Google Cloud Platform), in order to make a free forever VPS / VM you can read more on the offerings <a href=https://cloud.google.com/free/docs/gcp-free-tier>here</a>.</p> <figure> <p><img alt="gcp setup 1" src=../assets/gcp/1.png width=1000> </p> <figcaption>Navigate to https://cloud.google.com and press the "Get started for free" button</figcaption> </figure> <figure> <p><img alt="gcp setup 2" src=../assets/gcp/2.png width=1000> </p> <figcaption>Sign in if prompted. This part is country dependant, you shoud provide your mobile number for SMS verification</figcaption> </figure> <figure> <p><img alt="gcp setup 3" src=../assets/gcp/3.png width=1000> </p> <figcaption>Fill the form in, ensuring that the "Account type" is "Individual". Ignore the next few pop-ups that ask you to try products which are billable</figcaption> </figure> <figure> <p><img alt="gcp setup 4" src=../assets/gcp/5.png width=1000> </p> <figcaption>When you arrive at the home page, select the 'My First Project` dropdown in the upper left. Select 'NEW PROJECT'</figcaption> </figure> <figure> <p><img alt="gcp setup 5" src=../assets/gcp/6.png width=1000> </p> <figcaption>Name the project this can be anything you want, a project ID will automatically assigned. Click CREATE to finalize youe new project</figcaption> </figure> <figure> <p><img alt="gcp setup 6" src=../assets/gcp/7.png width=1000> </p> <figcaption>When the green tick appears next to your new project it is ready, click 'SELECT PROJECT'</figcaption> </figure> <figure> <p><img alt="gcp setup 7" src=../assets/gcp/8.png width=1000> </p> <figcaption>You are taken to the project dashboard, from here select the 'Compute Engine', then enable it on the page it opens. This can take a minute or two to fully enable so please be patient</figcaption> </figure> <h2 id=google-shell-api-vps-deployment-prep>Google Shell API &amp; VPS Deployment Prep<a class=headerlink href=#google-shell-api-vps-deployment-prep title="Permanent link">&para;</a></h2> <figure> <p><img alt="gcp setup 8" src=../assets/gcp/9.png width=1000> </p> <figcaption>Now that the Compute Engine is enabled, press the gshell icon in the upper right corner, this will load you into a Google Cloud Shell</figcaption> </figure> <figure> <p><img alt="gcp setup 9" src=../assets/gcp/10.png width=1000> </p> <figcaption>You will be automatically placed in your users home directory '/home/[USER]'. Copy the commands below to setup the dirs you'll need for the Terraform deployment</figcaption> </figure> <div class="tabbed-set tabbed-alternate" data-tabs=1:1><input checked=checked id=__tabbed_1_1 name=__tabbed_1 type=radio><div class=tabbed-labels><label for=__tabbed_1_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> bash</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><span class=nb>cd</span><span class=w> </span>~/<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>mkdir<span class=w> </span>terraform<span class=w> </span>compose_files<span class=w> </span>.ssh<span class=w> </span>startup<span class=w> </span>auth<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>ls
</code></pre></div> </div> </div> </div> <figure> <p><img alt="gcp setup 10" src=../assets/gcp/11.png width=1000> </p> <figcaption>You should now see all the directories listed here</figcaption> </figure> <p>Now it is time to clone my GitHub Repo into the <code>terraform</code> folder.</p> <div class="tabbed-set tabbed-alternate" data-tabs=2:1><input checked=checked id=__tabbed_2_1 name=__tabbed_2 type=radio><div class=tabbed-labels><label for=__tabbed_2_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> bash</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><span class=nb>cd</span><span class=w> </span>terraform<span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span>git<span class=w> </span>clone<span class=w> </span>https://github.com/Joeharrison94/terraform-gcp-ubuntu-container-ready-e2-micro-vm
</code></pre></div> </div> </div> </div> <figure> <p><img alt="gcp setup 11" src=../assets/gcp/12.png width=1000> </p> <figcaption>This is the output of the clone, following this we need to shuffle some of the files around to different folders. Using the 'Open Editor' in the upper right corner of the shell window</figcaption> </figure> <figure> <p><img alt="gcp setup 12" src=../assets/gcp/13.png width=1000> </p> <figcaption>I have listed all the files and paths you need to change below to make it easier to read</figcaption> </figure> <p>All of the files are currently in the <code>./terraform</code> folder to move them into the correct folder all you need to do is drag and drop them individually.</p> <div class="admonition tldr"> <p class=admonition-title>File Locations</p> <ul class=task-list> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled checked><span class=task-list-indicator></span></label> <code>docker-compose.yaml</code> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 9h5.5L13 3.5V9M6 2h8l6 6v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4c0-1.11.89-2 2-2m.12 13.5 3.74 3.74 1.42-1.41-2.33-2.33 2.33-2.33-1.42-1.41-3.74 3.74m11.16 0-3.74-3.74-1.42 1.41 2.33 2.33-2.33 2.33 1.42 1.41 3.74-3.74Z"/></svg></span> <img alt=➡ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/27a1.svg title=:arrow_right:> <img alt=➡ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/27a1.svg title=:arrow_right:> <code>./compose_files</code> <img alt=📁 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f4c1.svg title=:file_folder:></li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled checked><span class=task-list-indicator></span></label> <code>startup.sh</code> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 9h5.5L13 3.5V9M6 2h8l6 6v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4c0-1.11.89-2 2-2m.12 13.5 3.74 3.74 1.42-1.41-2.33-2.33 2.33-2.33-1.42-1.41-3.74 3.74m11.16 0-3.74-3.74-1.42 1.41 2.33 2.33-2.33 2.33 1.42 1.41 3.74-3.74Z"/></svg></span> <img alt=➡ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/27a1.svg title=:arrow_right:> <img alt=➡ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/27a1.svg title=:arrow_right:> <code>./startup</code> <img alt=📁 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f4c1.svg title=:file_folder:></li> <li class=task-list-item><label class=task-list-control><input type=checkbox disabled checked><span class=task-list-indicator></span></label> <code>*.tf</code> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 5.4v6.4L15.4 15V8.7L21 5.4m-6.2 3.3V15l-5.6-3.2V5.4l5.6 3.3m0 7v6.4l-5.6-3.2v-6.4l5.6 3.2M8.6 5.1v6.4L3 8.3V1.9l5.6 3.2Z"/></svg></span> <img alt=➡ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/27a1.svg title=:arrow_right:> <img alt=➡ class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/27a1.svg title=:arrow_right:> <code>./terraform</code> <img alt=📁 class=twemoji src=https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/1f4c1.svg title=:file_folder:></li> </ul> <div class="tabbed-set tabbed-alternate" data-tabs=3:1><input checked=checked id=__tabbed_3_1 name=__tabbed_3 type=radio><div class=tabbed-labels><label for=__tabbed_3_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> Folder Structure</label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class=highlight><pre><span></span><code>.<span class=w>                                                                                             </span>
├─<span class=w> </span>auth/<span class=w>                               </span><span class=c1># Folder to store the API user credentials             </span>
├─<span class=w> </span>compose_files/<span class=w>                                                                             </span>
│<span class=w>  </span>└─<span class=w> </span>docker-compose.yaml<span class=w>              </span><span class=c1># Docker compose configuration file                    </span>
├─<span class=w> </span>startup/<span class=w>                                                                                   </span>
│<span class=w>  </span>└─<span class=w> </span>startup.sh<span class=w>                       </span><span class=c1># Startup script to install dependancies               </span>
└─<span class=w> </span>terraform/<span class=w>                                                                                 </span>
<span class=w>   </span>├─<span class=w> </span>network-firewall.tf<span class=w>              </span><span class=c1># Network Firewall Rule Definitions                    </span>
<span class=w>   </span>├─<span class=w> </span>network-main.tf<span class=w>                  </span><span class=c1># Network Definitions                                  </span>
<span class=w>   </span>├─<span class=w> </span>network-variables.tf<span class=w>             </span><span class=c1># Network Terraform Variable Definitions               </span>
<span class=w>   </span>├─<span class=w> </span>provider-main.tf<span class=w>                 </span><span class=c1># GCP Providers Definitions                            </span>
<span class=w>   </span>├─<span class=w> </span>provider-variables.tf<span class=w>            </span><span class=c1># GCP Providers Terraform Variable Definitions         </span>
<span class=w>   </span>├─<span class=w> </span>terraform.tfvars<span class=w>                 </span><span class=c1># Terraform Variable Definitions                       </span>
<span class=w>   </span>├─<span class=w> </span>ubnt-versions.tf<span class=w>                 </span><span class=c1># Ubuntu Version Definitions                           </span>
<span class=w>   </span>├─<span class=w> </span>ubnt-vm-main.tf<span class=w>                  </span><span class=c1># Main VM Configuration Definitions                    </span>
<span class=w>   </span>├─<span class=w> </span>ubnt-vm-output.tf<span class=w>                </span><span class=c1># Information To Display When Provisioning Completes   </span>
<span class=w>   </span>└─<span class=w> </span>ubnt-vm-variables.tf<span class=w>             </span><span class=c1># Main VM Terraform Variable Definitions               </span>
</code></pre></div> </div> <p>Now to edit the <code>.tf</code> and <code>.tfvars</code> files inside the <code>./terraform</code> folder. I'm not going to go through them all as they explain what needs altering fairly well, but some pointers:</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p><code>IDENTIFIER</code> must be changed in <code>NETWORK-FIREWALL</code> and <code>NETWORK-MAIN</code> files - it doesn't matter what you change it to, but keep it short and the same.</p> <p>The <code>terraform.tfvars</code> requires your <code>project ID</code> , <code>project name</code> , and for you to change the <code>user</code>. This user should be your email address without the @gmail.com, where <code>me@gmail.com</code> becomes <code>me</code>.</p> </div> <div class="admonition caution"> <p class=admonition-title>Caution</p> <p>Do not change the <code>GCP region</code> or <code>zone</code> as the ones selected are in the free forever locations, if you change these you may incur costs.</p> </div> <figure> <p><img alt="gcp setup 13" src=../assets/gcp/14.png width=1000> </p> <figcaption>Example modification of `terraform.tfvars`</figcaption> </figure> <h2 id=api-user-setup>API User Setup<a class=headerlink href=#api-user-setup title="Permanent link">&para;</a></h2> <p>Navigate back to or reopen your Google Cloud Shell terminal.</p> <p>We will now create the SSH keys that you will use to access the VM once it is deployed. Changing the part in [ ] to something else, this is the comment.</p> <div class="tabbed-set tabbed-alternate" data-tabs=4:1><input checked=checked id=__tabbed_4_1 name=__tabbed_4 type=radio><div class=tabbed-labels><label for=__tabbed_4_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> bash</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><span class=nb>cd</span><span class=w> </span>~/
ssh-keygen<span class=w> </span>-t<span class=w> </span>ed25519<span class=w> </span>-f<span class=w> </span>~/.ssh/sshkey<span class=w> </span>-C<span class=w> </span><span class=o>[</span>KeysForVPSAccess<span class=o>]</span>
</code></pre></div> </div> </div> </div> <p>Follow the on-screen instructions and do not set a passphrase, when asked leave it blank and press enter.</p> <p>When this process completes, you will have <code>sshkey</code> and <code>sshkey.pub</code> in your <code>/home/user/.ssh</code> folder.</p> <figure> <p><img alt="gcp setup 14" src=../assets/gcp/15.png width=1000> </p> <figcaption>Output of the aforementioned SSH keypair creation process</figcaption> </figure> <p>We need to create a service account to use Terraform <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 5.4v6.4L15.4 15V8.7L21 5.4m-6.2 3.3V15l-5.6-3.2V5.4l5.6 3.3m0 7v6.4l-5.6-3.2v-6.4l5.6 3.2M8.6 5.1v6.4L3 8.3V1.9l5.6 3.2Z"/></svg></span> with and give it all the required permissions necessary to provision the VM.</p> <div class="admonition warning"> <p class=admonition-title>You may need to authorize the API the first time you run one of the below commands</p> </div> <div class="tabbed-set tabbed-alternate" data-tabs=5:1><input checked=checked id=__tabbed_5_1 name=__tabbed_5 type=radio><div class=tabbed-labels><label for=__tabbed_5_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> bash</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><span class=c1># Run all these commands individually and ensure each one completes before moving onto the next one</span>

<span class=c1>##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~##</span>
<span class=c1>## Ensure that you update PROJECT-ID-HERE with your project ID. ##</span>
<span class=c1>##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~##</span>

<span class=c1># Change working directory to the users home folder</span>
<span class=nb>cd</span><span class=w> </span>~/

<span class=c1># Creates a service account named tf-serviceaccount </span>
gcloud<span class=w> </span>iam<span class=w> </span>service-accounts<span class=w> </span>create<span class=w> </span>tf-serviceaccount<span class=w> </span>--description<span class=o>=</span><span class=s2>&quot;service account for terraform&quot;</span><span class=w> </span>--display-name<span class=o>=</span><span class=s2>&quot;terraform_service_account&quot;</span>

<span class=c1># List accounts to ensure it was created</span>
gcloud<span class=w> </span>iam<span class=w> </span>service-accounts<span class=w> </span>list

<span class=c1># Create keys for the service account to use when provisioning and store them in the auth folder.</span>
gcloud<span class=w> </span>iam<span class=w> </span>service-accounts<span class=w> </span>keys<span class=w> </span>create<span class=w> </span>~/auth/google-key.json<span class=w> </span>--iam-account<span class=w> </span>tf-serviceaccount@PROJECT-ID-HERE.iam.gserviceaccount.com
</code></pre></div> </div> </div> </div> <p>With this done we will now add the following permissions to the service account.</p> <div class="tabbed-set tabbed-alternate" data-tabs=6:1><input checked=checked id=__tabbed_6_1 name=__tabbed_6 type=radio><div class=tabbed-labels><label for=__tabbed_6_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> bash</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><span class=c1># Run all these commands individually and ensure each one completes before moving onto the next one</span>

<span class=c1>##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~##</span>
<span class=c1>## Ensure that you update PROJECT-ID-HERE with your project ID. ##</span>
<span class=c1>##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~##</span>

gcloud<span class=w> </span>services<span class=w> </span><span class=nb>enable</span><span class=w> </span>cloudresourcemanager.googleapis.com

gcloud<span class=w> </span>services<span class=w> </span><span class=nb>enable</span><span class=w> </span>cloudbilling.googleapis.com

gcloud<span class=w> </span>services<span class=w> </span><span class=nb>enable</span><span class=w> </span>iam.googleapis.com

gcloud<span class=w> </span>services<span class=w> </span><span class=nb>enable</span><span class=w> </span>storage.googleapis.com

gcloud<span class=w> </span>services<span class=w> </span><span class=nb>enable</span><span class=w> </span>serviceusage.googleapis.com

gcloud<span class=w> </span>projects<span class=w> </span>add-iam-policy-binding<span class=w> </span>PROJECT-ID-HERE<span class=w> </span>--member<span class=w> </span>serviceAccount:tf-serviceaccount@PROJECT-ID-HERE.iam.gserviceaccount.com<span class=w> </span>--role<span class=w> </span>roles/viewer

gcloud<span class=w> </span>projects<span class=w> </span>add-iam-policy-binding<span class=w> </span>PROJECT-ID-HERE<span class=w> </span>--member<span class=w> </span>serviceAccount:tf-serviceaccount@PROJECT-ID-HERE.iam.gserviceaccount.com<span class=w> </span>--role<span class=w> </span>roles/storage.admin

gcloud<span class=w> </span>projects<span class=w> </span>add-iam-policy-binding<span class=w> </span>PROJECT-ID-HERE<span class=w> </span>--member<span class=w> </span>serviceAccount:tf-serviceaccount@PROJECT-ID-HERE.iam.gserviceaccount.com<span class=w> </span>--role<span class=w> </span>roles/compute.instanceAdmin.v1

gcloud<span class=w> </span>projects<span class=w> </span>add-iam-policy-binding<span class=w> </span>PROJECT-ID-HERE<span class=w> </span>--member<span class=w> </span>serviceAccount:tf-serviceaccount@PROJECT-ID-HERE.iam.gserviceaccount.com<span class=w> </span>--role<span class=w> </span>roles/compute.networkAdmin

gcloud<span class=w> </span>projects<span class=w> </span>add-iam-policy-binding<span class=w> </span>PROJECT-ID-HERE<span class=w> </span>--member<span class=w> </span>serviceAccount:tf-serviceaccount@PROJECT-ID-HERE.iam.gserviceaccount.com<span class=w> </span>--role<span class=w> </span>roles/compute.securityAdmin
</code></pre></div> </div> </div> </div> <h2 id=vps-vm-deployment>VPS / VM Deployment<a class=headerlink href=#vps-vm-deployment title="Permanent link">&para;</a></h2> <p>Now that we have created the service account you can now use Terraform <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 5.4v6.4L15.4 15V8.7L21 5.4m-6.2 3.3V15l-5.6-3.2V5.4l5.6 3.3m0 7v6.4l-5.6-3.2v-6.4l5.6 3.2M8.6 5.1v6.4L3 8.3V1.9l5.6 3.2Z"/></svg></span> to create the VM.</p> <div class="tabbed-set tabbed-alternate" data-tabs=7:1><input checked=checked id=__tabbed_7_1 name=__tabbed_7 type=radio><div class=tabbed-labels><label for=__tabbed_7_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> bash</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><span class=nb>cd</span><span class=w> </span>~/terraform
terraform<span class=w> </span>init
</code></pre></div> </div> </div> </div> <figure> <p><img alt="gcp setup 15" src=../assets/gcp/17.png width=1000> </p> <figcaption>Terraform Initialization</figcaption> </figure> <p>If the init returns with no errors, then we can move onto the <code>plan</code> stage.</p> <div class="tabbed-set tabbed-alternate" data-tabs=8:1><input checked=checked id=__tabbed_8_1 name=__tabbed_8 type=radio><div class=tabbed-labels><label for=__tabbed_8_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> bash</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code>terraform<span class=w> </span>plan
</code></pre></div> </div> </div> </div> <p>When prompted type a name for your VM, type in anything you want but keep it simple.</p> <p>If the plan returns with no errors, we can move onto the final stage where it will apply the config. When you proceed ensure that you type in the same VM name that you entered in the plan stage. Finally when prompted type 'yes' then hit enter to deploy your VM.</p> <div class="tabbed-set tabbed-alternate" data-tabs=9:1><input checked=checked id=__tabbed_9_1 name=__tabbed_9 type=radio><div class=tabbed-labels><label for=__tabbed_9_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> bash</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code>terraform<span class=w> </span>apply
</code></pre></div> </div> </div> </div> <figure> <p><img alt="gcp setup 17" src=../assets/gcp/18.png width=1000> </p> <figcaption>Terraform Applying</figcaption> </figure> <p>The full deployment and configuration will take some time to complete fully, but if everything was configured according to this guide, your screen should show that 7 resources have been added without fault.</p> <p>Head back to your <code>Compute Engine</code>, and check out <code>VM Instances</code>, your VM will be ready and waiting.</p> <figure> <p><img alt="gcp setup 18" src=../assets/gcp/19.png width=1000> </p> <figcaption>Behold Your VM</figcaption> </figure> <div class="admonition caution"> <p class=admonition-title>Caution</p> <p>An important thing to note, is that as part of the <code>startup.sh</code> script it will install and configure docker &amp; docker compose and inject the compose file. </p> <p>Because of this I would give the VM time to complete all the actions it needs to before you login, 5-10 minutes should be ample time.</p> </div> <p>Now click the <code>SSH</code> button this will prompt a browser window, and after injecting the SSH keys (takes a while, so don't worry), it will successfully connect to the VM.</p> <figure> <p><img alt="gcp setup 19" src=../assets/gcp/20.png width=1000> </p> <figcaption>Accessing The VM</figcaption> </figure> <div class="admonition tip"> <p class=admonition-title>Quick Note</p> <p>You can use the private key <code>~/.ssh/sshkey</code> to SSH into the machine using the public IP remotely, you can see the IP displayed in your Terraform outputs.</p> </div> <h2 id=docker-containers-uptime-kuma-healthschecks>Docker Containers - Uptime Kuma &amp; Healthschecks!<a class=headerlink href=#docker-containers-uptime-kuma-healthschecks title="Permanent link">&para;</a></h2> <p>Navigate to the directory <code>/mnt/disks/docker/projects/app</code> <code>ls</code> the directory to find the injected <code>docker-compose.yaml</code> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 9h5.5L13 3.5V9M6 2h8l6 6v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4c0-1.11.89-2 2-2m.12 13.5 3.74 3.74 1.42-1.41-2.33-2.33 2.33-2.33-1.42-1.41-3.74 3.74m11.16 0-3.74-3.74-1.42 1.41 2.33 2.33-2.33 2.33 1.42 1.41 3.74-3.74Z"/></svg></span></p> <div class="tabbed-set tabbed-alternate" data-tabs=10:1><input checked=checked id=__tabbed_10_1 name=__tabbed_10 type=radio><div class=tabbed-labels><label for=__tabbed_10_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> bash</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><span class=nb>cd</span><span class=w> </span>/mnt/disks/docker/projects/app
ls
</code></pre></div> </div> </div> </div> <details class=question> <summary>My docker-compose.yaml file is missing? Click Here</summary> <p>If for some reason the docker-compose.yaml hasn't been injected after 15 minutes of VM uptime for whatever reason. Create it with the below commands.</p> <div class="tabbed-set tabbed-alternate" data-tabs=11:1><input checked=checked id=__tabbed_11_1 name=__tabbed_11 type=radio><div class=tabbed-labels><label for=__tabbed_11_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> bash</label></div> <div class=tabbed-content> <div class=tabbed-block></div> </div> </div> <div class=highlight><pre><span></span><code><span class=nb>cd</span><span class=w> </span>/mnt/disks/docker/projects/app

sudo<span class=w> </span>touch<span class=w> </span>docker-compose.yaml

<span class=c1># After the below command runs it will open the empy file, copy in the contents of the file from my GitHub repo, save it then exit with &#39;CTRL + S&#39; then &#39;CTRL + X&#39;</span>
sudo<span class=w> </span>nano<span class=w> </span>docker-compose.yaml<span class=w> </span>
</code></pre></div> </details> <p>Navigate to the docker folder, then create the folders below and spin up the docker containers.</p> <div class="tabbed-set tabbed-alternate" data-tabs=12:1><input checked=checked id=__tabbed_12_1 name=__tabbed_12 type=radio><div class=tabbed-labels><label for=__tabbed_12_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> bash</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code><span class=nb>cd</span><span class=w> </span>/mnt/disks/docker

sudo<span class=w> </span>mkdir<span class=w> </span>uptime-kuma<span class=w> </span>healthchecks

<span class=c1># Option 1</span>
sudo<span class=w> </span>docker<span class=w> </span>compose<span class=w> </span>-f<span class=w> </span>/mnt/disks/docker/projects/app/docker-compose.yaml<span class=w> </span>up<span class=w> </span>-d

<span class=c1># Option 2</span>
<span class=c1># You can either add your user to the &#39;docker&#39; user group so you dont have to use sudo to run docker commands, or just use sudo</span>
sudo<span class=w> </span>usermod<span class=w> </span>-aG<span class=w> </span>docker<span class=w> </span><span class=nv>$USER</span>
docker<span class=w> </span>compose<span class=w> </span>-f<span class=w> </span>/mnt/disks/docker/projects/app/docker-compose.yaml<span class=w> </span>up<span class=w> </span>-d
</code></pre></div> </div> </div> </div> <p>Check that your containers up and running.</p> <div class="tabbed-set tabbed-alternate" data-tabs=13:1><input checked=checked id=__tabbed_13_1 name=__tabbed_13 type=radio><div class=tabbed-labels><label for=__tabbed_13_1><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 9h2.31l.32-3h2l-.32 3h2l.32-3h2l-.32 3H15v2h-1.9l-.2 2H15v2h-2.31l-.32 3h-2l.32-3h-2l-.32 3h-2l.32-3H5v-2h1.9l.2-2H5V9m4.1 2-.2 2h2l.2-2M19 6h-2v8h2m0 2h-2v2h2Z"/></svg></span> bash</label></div> <div class=tabbed-content> <div class=tabbed-block> <div class=highlight><pre><span></span><code>sudo<span class=w> </span>docker<span class=w> </span>ps<span class=w> </span><span class=c1># Or just &#39;docker ps&#39; if you added your user to the &#39;docker&#39; user group</span>
</code></pre></div> </div> </div> </div> <figure> <p><img alt="gcp setup 20" src=../assets/gcp/21.png width=1000> </p> <figcaption>Checking The Docker Containers</figcaption> </figure> <p>Your containers are now running and functional!</p> <h2 id=setting-the-public-firewall>Setting The Public Firewall<a class=headerlink href=#setting-the-public-firewall title="Permanent link">&para;</a></h2> <p>But now you need to access them, access for now will be via the public IP and the port. Right now it will not work as you have now rules to allow it.</p> <p>Take note of the uptime-kuma port (3001). </p> <p>Head over to the VM page (we no longer require te cloud terminal, close it if you so wish).</p> <figure> <p><img alt="gcp setup 21" src=../assets/gcp/22.png width=1000> </p> <figcaption>Opening The Firewall</figcaption> </figure> <p>Click the button <code>Set up firewall rules</code> then <code>CREATE FIREWALL RULE</code> at the top of the page. Follow the onscreen prompts adding a rule name, network information and port.</p> <figure> <p><img alt="gcp setup 22" src=../assets/gcp/23.gif width=1000> </p> <figcaption>Setting The Firewall</figcaption> </figure> <p>Take note of the external IP of your VM in the <code>VM instances</code> screen, in a new browser tab navigate to http://EXTERNALIP:3001</p> <p>This will take you to your Uptime Kuma service!</p> <figure> <p><img alt="gcp setup 23" src=../assets/gcp/24.png width=1000> </p> <figcaption>First Time Setup Screen - Uptime Kuma</figcaption> </figure> <div class="admonition note"> <p class=admonition-title>Final Note</p> <p>By Default Google sets the VM networking to premium, so dont forget to go and change it to standard, as shown here.</p> <p><img alt=image src=https://user-images.githubusercontent.com/53116754/171113057-e9b5409d-1719-422e-a28c-36da70bfee2d.png></p> </div> <p>Congratulations! You've got access to your Uptime-Kuma instance!, you can also follow the same steps with regards to the Healthchecks container.</p> <div class="admonition success"> <p class=admonition-title>Success</p> <p>CONGRATULATIONS! You have successfully deployed a Google Cloud Platform VM with functional docker containers using Terraform!</p> </div> <p>However this method of access is not secure at all as anyone can access you service if they have the IP and port of your VM not to mention it is plain text HTTP a BIG no no. We need HTTPS This is where Cloudflare and their awesome suite of security tools save the day. I have a seperate guide that runs through all of this which I will link to in the section below.</p> <p>Thanks for reading and happy home labbing!</p> <h2 id=setting-up-a-cloudflared-argo-tunnel-with-zero-trust>Setting Up A Cloudflared Argo Tunnel With Zero Trust!<a class=headerlink href=#setting-up-a-cloudflared-argo-tunnel-with-zero-trust title="Permanent link">&para;</a></h2> <p><a href=../cloudflared/ >Cloudflared Argo Tunnels with Zero Trust!</a></p> <h2 id=links>Links<a class=headerlink href=#links title="Permanent link">&para;</a></h2> <p>An honourable mention to <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M373 138.6c-25.2 0-46.3-17.5-51.9-41-30.6 4.3-54.2 30.7-54.2 62.4v.2c47.4 1.8 90.6 15.1 124.9 36.3 12.6-9.7 28.4-15.5 45.5-15.5 41.3 0 74.7 33.4 74.7 74.7 0 29.8-17.4 55.5-42.7 67.5-2.4 86.8-97 156.6-213.2 156.6S45.5 410.1 43 323.4c-25.4-11.9-43-37.7-43-67.7C0 214.4 33.4 181 74.7 181c17.2 0 33 5.8 45.7 15.6 34-21.1 76.8-34.4 123.7-36.4v-.3c0-44.3 33.7-80.9 76.8-85.5C325.8 50.2 347.2 32 373 32c29.4 0 53.3 23.9 53.3 53.3s-23.9 53.3-53.3 53.3zM157.5 255.3c-20.9 0-38.9 20.8-40.2 47.9s17.1 38.1 38 38.1 36.6-9.8 37.8-36.9-14.7-49.1-35.7-49.1zM395 303.1c-1.2-27.1-19.2-47.9-40.2-47.9s-36.9 22-35.7 49.1c1.2 27.1 16.9 36.9 37.8 36.9s39.3-11 38-38.1zm-60.1 70.8c1.5-3.6-1-7.7-4.9-8.1-23-2.3-47.9-3.6-73.8-3.6s-50.8 1.3-73.8 3.6c-3.9.4-6.4 4.5-4.9 8.1 12.9 30.8 43.3 52.4 78.7 52.4s65.8-21.6 78.7-52.4z"/></svg></span> <code>u/BackedUpBooty</code> for supplying me with all the screenshots I used for this guide and for the lovely writeup he gave me that inspired me to improve my doc's for this project <a href=https://academy.pointtosource.com/general/service-monitoring/ >Link to the blog post here!</a>.</p> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Made with ❤️ by J Harrison </div> </div> <div class=md-social> <a href=https://github.com/sudo-kraken target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["toc.integrate", "navigation.top", "navigation.expand", "navigation.tracking", "search.suggest", "search.highlight", "search.share", "navigation.sections", "content.tabs.link"], "search": "../assets/javascripts/workers/search.c011b7c0.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../assets/javascripts/bundle.7389ff0e.min.js></script> <script src=../javascripts/extra.js></script> </body> </html>